if args.all_fqdns:
    fqdn_list = get_all_fqdns(session, base_url, debug=args.debug)
    print(f"\n[INFO] Retrieved {len(fqdn_list)} FQDNs from PAPI.")
    print(f"[INFO] Running reverse lookup for {len(fqdn_list)} FQDNs...\n")

    csv_data = []  # Initialize once before the loop

    for fqdn_item in sorted(fqdn_list):
        reverse_result = reverse_fqdn_lookup(session, base_url, fqdn_item, debug=args.debug)

        print(f"\nFQDN: {fqdn_item}")

        if reverse_result["found"]:
            access_group = reverse_result.get("accessGroupName", "UNKNOWN")
            property_name = reverse_result.get("propertyName", "UNKNOWN")
            stripped_name = reverse_result.get("strippedPropertyName", "UNKNOWN")
            match_flag = "TRUE" if stripped_name.lower() == access_group.lower() else "FALSE"

            print(f"Access Group: {access_group}")
            print(f"Property: {property_name}")
            print(f"Match: {match_flag}")

            csv_data.append({
                "FQDN": fqdn_item,
                "GroupId": reverse_result.get("groupId", ""),
                "AccessGroupName": access_group,
                "PropertyName": property_name,
                "StrippedPropertyName": stripped_name,
                "MatchType": reverse_result.get("matchType", ""),
                "AccessGroupMatch": match_flag,
            })

        else:
            print(f"[WARN] No reverse lookup results for {fqdn_item}\n")

    # Export once after all lookups complete
    os.makedirs("output", exist_ok=True)
    csv_file = f"output/reverse_fqdn_summary_{sanitize_filename(fqdn)}.csv"
    with open(csv_file, "w", newline="", encoding="utf-8") as f:
        fieldnames = [
            "FQDN", "GroupId", "AccessGroupName", "PropertyName",
            "StrippedPropertyName", "MatchType", "AccessGroupMatch"
        ]
        writer = csv.DictWriter(f, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(csv_data)

    print(f"\n[INFO] Reverse FQDN summary written to: {csv_file}")
    print(f"[INFO] Total FQDNs processed: {len(csv_data)}")
    print(f"[INFO] All reverse lookups complete.\n")
    return
