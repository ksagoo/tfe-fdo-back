#!/bin/bash
# =====================================================
#  Akamai Certificate Lifecycle Automation
# =====================================================
#  Description:
#    Executes live Akamai CPS API operations:
#      • Discover expiring enrollments
#      • Renew certificates
#      • Deploy certificates (immediate or scheduled)
#      • Poll CPS status for completion
#
#  Default Behavior:
#    - Automatically discovers the first expiring enrollment from API results
#    - Uses that enrollment for renew/deploy/poll tests
#    - Manual override supported via --enrollment-id and --fqdn
#
#  Typical Usage:
#    ./test_suite_live.sh --section APAC --network production --test all
#    ./test_suite_live.sh --section EMEA --network staging --expiry-threshold 30
#    ./test_suite_live.sh --test 2                          # Run only Renew test
#    ./test_suite_live.sh --enrollment-id 105672 --fqdn portal.hsbc.com --test 4
#
#  Notes:
#    - Results are written under ./output/
#    - PIPELINE_RESULT exported for CI/CD
#    - Safe for use in Jenkins, GitLab, or local validation
# =====================================================

usage() {
  echo ""
  echo "Usage: $0 [OPTIONS]"
  echo ""
  echo "Options:"
  echo "  --section SECTION            Akamai API .edgerc section (default: APAC)"
  echo "  --access-group GROUP         Access group name (default: AppSec)"
  echo "  --fqdn DOMAIN                FQDN (auto-discovered if not specified)"
  echo "  --enrollment-id ID           Enrollment ID (auto-discovered if not specified)"
  echo "  --network [staging|production] Deployment network (default: production)"
  echo "  --expiry-threshold DAYS      Days before expiry to include (default: 45)"
  echo "  --poll-interval SECONDS      Interval between poll checks (default: 30)"
  echo "  --poll-timeout SECONDS       Max poll duration (default: 900)"
  echo "  --test N                     Run a specific test (1–5) or 'all' (default: all)"
  echo "  --help                       Show this help message"
  echo ""
  echo "Examples:"
  echo "  $0 --section APAC --network production --test all"
  echo "  $0 --section EMEA --network staging --expiry-threshold 30"
  echo "  $0 --test 3                          # Deploy only"
  echo "  $0 --enrollment-id 105672 --fqdn portal.hsbc.com --test 4"
  echo ""
  exit 0
}

# -----------------------------------------------------
# Default configuration
# -----------------------------------------------------
SECTION="APAC"
ACCESS_GROUP="AppSec"
FQDN=""
ENROLLMENT_ID=""
NETWORK="production"
EXPIRY_THRESHOLD=45
POLL_INTERVAL=30
POLL_TIMEOUT=900
DEBUG=true
JSON_ONLY=true
TEST="all"

# -----------------------------------------------------
# Parse CLI arguments
# -----------------------------------------------------
while [[ $# -gt 0 ]]; do
  case $1 in
    --section) SECTION="$2"; shift 2;;
    --access-group) ACCESS_GROUP="$2"; shift 2;;
    --fqdn) FQDN="$2"; shift 2;;
    --enrollment-id) ENROLLMENT_ID="$2"; shift 2;;
    --network) NETWORK="$2"; shift 2;;
    --expiry-threshold) EXPIRY_THRESHOLD="$2"; shift 2;;
    --poll-interval) POLL_INTERVAL="$2"; shift 2;;
    --poll-timeout) POLL_TIMEOUT="$2"; shift 2;;
    --test) TEST="$2"; shift 2;;
    -h|--help) usage;;
    *) echo "Unknown option: $1"; usage;;
  esac
done

# -----------------------------------------------------
# Environment setup
# -----------------------------------------------------
set -Eeo pipefail
OUTPUT_DIR="output"
mkdir -p "$OUTPUT_DIR"
TOTAL=0
PASS=0
FAIL=0

# -----------------------------------------------------
# Test runner helper
# -----------------------------------------------------
run_test() {
  local name="$1"
  local cmd="$2"
  local id="$3"

  if [[ "$TEST" != "all" && "$TEST" != "$id" ]]; then
    return
  fi

  echo -e "\n[TEST $id]: $name"
  echo "-----------------------------------------------------"
  echo "COMMAND: $cmd"
  local start_time=$(date +%s)

  set +e
  eval $cmd >>"$OUTPUT_DIR/test_live.log" 2>&1
  local status=$?
  set -e
  local end_time=$(date +%s)
  local duration=$((end_time - start_time))

  TOTAL=$((TOTAL + 1))
  if [[ $status -ne 0 ]] || grep -q "\[FAILURE\]" "$OUTPUT_DIR/debug.log" 2>/dev/null; then
    echo "[RESULT]: FAIL (${duration}s)"
    FAIL=$((FAIL + 1))
  else
    echo "[RESULT]: SUCCESS (${duration}s)"
    PASS=$((PASS + 1))
  fi
  echo "-----------------------------------------------------"
  sleep 1
}

# -----------------------------------------------------
# Suite header
# -----------------------------------------------------
echo "====================================================="
echo " Akamai CPS Certificate Live Test Suite"
echo "====================================================="
echo " Section:            ${SECTION}"
echo " Access Group:       ${ACCESS_GROUP}"
echo " Deployment Network: ${NETWORK}"
echo " Expiry Threshold:   ${EXPIRY_THRESHOLD} days"
echo " Selected Test:      ${TEST}"
echo "-----------------------------------------------------"

# =====================================================
# 1. Get All Expiring Enrollments
# =====================================================
run_test "Get All Expiring Enrollments" \
"python akamai_cert_manager.py \
  --section ${SECTION} \
  --access_group ${ACCESS_GROUP} \
  --action get_enrollment \
  --deployment-network ${NETWORK} \
  --expiry-threshold ${EXPIRY_THRESHOLD} \
  --json-only --debug" "1"

# =====================================================
# Auto-detect enrollment and FQDN (unless manually provided)
# =====================================================
if [[ -z "$ENROLLMENT_ID" || -z "$FQDN" ]]; then
  if [[ -f "$OUTPUT_DIR/discovered_enrollments.json" ]]; then
    echo "[INFO] Attempting to auto-select first enrollment from discovery output..."
    ENROLLMENT_ID=$(jq -r '.[0].enrollment_id' "$OUTPUT_DIR/discovered_enrollments.json" 2>/dev/null)
    FQDN=$(jq -r '.[0].fqdn' "$OUTPUT_DIR/discovered_enrollments.json" 2>/dev/null)
    if [[ "$ENROLLMENT_ID" == "null" || -z "$ENROLLMENT_ID" ]]; then
      echo "[WARN] No valid enrollment found in discovery output; manual override required."
    else
      echo "[INFO] Auto-selected Enrollment ID: $ENROLLMENT_ID"
      echo "[INFO] Auto-selected FQDN:          $FQDN"
    fi
  else
    echo "[WARN] Discovery output not found; skipping auto-selection."
  fi
fi

# =====================================================
# 2. Renew Only
# =====================================================
run_test "Renew Only" \
"python akamai_cert_manager.py \
  --section ${SECTION} \
  --access_group ${ACCESS_GROUP} \
  --fqdn ${FQDN} \
  --enrollment_id ${ENROLLMENT_ID} \
  --action renew_only \
  --deployment-network ${NETWORK} \
  --json-only --debug" "2"

# =====================================================
# 3. Deploy Only
# =====================================================
run_test "Deploy Only" \
"python akamai_cert_manager.py \
  --section ${SECTION} \
  --access_group ${ACCESS_GROUP} \
  --fqdn ${FQDN} \
  --enrollment_id ${ENROLLMENT_ID} \
  --action deploy_only \
  --deployment-network ${NETWORK} \
  --json-only --debug" "3"

# =====================================================
# 4. Full Renew + Deploy + Poll
# =====================================================
run_test "Full Lifecycle (Renew + Deploy + Poll)" \
"python akamai_cert_manager.py \
  --section ${SECTION} \
  --access_group ${ACCESS_GROUP} \
  --fqdn ${FQDN} \
  --enrollment_id ${ENROLLMENT_ID} \
  --action renew_and_deploy \
  --deployment-network ${NETWORK} \
  --poll-interval ${POLL_INTERVAL} \
  --poll-timeout ${POLL_TIMEOUT} \
  --json-only --debug" "4"

# =====================================================
# 5. Scheduled Deployment (1 hour ahead)
# =====================================================
SCHEDULE_TIME=$(date -u -d '+1 hour' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -v+1H -u '+%Y-%m-%dT%H:%M:%SZ')
echo "[INFO] Scheduled deployment time (UTC): ${SCHEDULE_TIME}"

run_test "Scheduled Deployment (Future Start Time)" \
"python akamai_cert_manager.py \
  --section ${SECTION} \
  --access_group ${ACCESS_GROUP} \
  --fqdn ${FQDN} \
  --enrollment_id ${ENROLLMENT_ID} \
  --action deploy_only \
  --deployment-network ${NETWORK} \
  --schedule-time ${SCHEDULE_TIME} \
  --json-only --debug" "5"

# =====================================================
# Summary
# =====================================================
echo "====================================================="
echo " Live Test Suite Summary"
echo "====================================================="
echo " Total Tests Executed : $TOTAL"
echo " Passed               : $PASS"
echo " Failed               : $FAIL"
echo "-----------------------------------------------------"

if [[ $FAIL -eq 0 ]]; then
  PIPELINE_RESULT="SUCCESS"
else
  PIPELINE_RESULT="FAILURE"
fi

echo "PIPELINE_RESULT=$PIPELINE_RESULT"
echo "====================================================="
echo " Live Test Suite Completed ($PIPELINE_RESULT)"
echo "====================================================="










#!/bin/bash
# ===================================================================
#  Akamai Certificate Lifecycle Automation - Dry-Run Test Suite
# ===================================================================
#  Description:
#    Simulates all major CPS lifecycle operations safely with --dry-run mode.
#    Exercises every logical path in akamai_cert_manager.py without real API calls.
#
#  Default Behavior:
#    • Executes 12 test cases covering renew, deploy, schedule, expiry windows, etc.
#    • Writes outputs to ./output/ for inspection
#    • Exports PIPELINE_RESULT for CI/CD pipelines
#
#  Typical Usage:
#    ./test_suite_dryrun.sh                      # Run all tests
#    ./test_suite_dryrun.sh --test 7             # Run specific test case
#    ./test_suite_dryrun.sh --section DEV --access-group AppSec
#
#  Options:
#    --section SECTION            Akamai .edgerc section (default: DEV)
#    --access-group GROUP         Access group name (default: AppSec)
#    --test N                     Run specific test (1–12) or 'all' (default: all)
#    --help                       Show usage
#
#  Output:
#    • Logs: ./output/test_dryrun.log
#    • JSON outputs: ./output/result_*.json
#    • PIPELINE_RESULT exported for CI/CD
#
# =====================================================

usage() { grep '^#' "$0" | sed 's/^# \{0,1\}//'; exit 0; }

# -----------------------------------------------------
# Defaults
# -----------------------------------------------------
SECTION="DEV"
ACCESS_GROUP="AppSec"
TEST="all"
OUTPUT_DIR="output"
mkdir -p "$OUTPUT_DIR"
set -Eeo pipefail
TOTAL=0; PASS=0; FAIL=0

# -----------------------------------------------------
# Argument parsing
# -----------------------------------------------------
while [[ $# -gt 0 ]]; do
  case $1 in
    --section) SECTION="$2"; shift 2;;
    --access-group) ACCESS_GROUP="$2"; shift 2;;
    --test) TEST="$2"; shift 2;;
    -h|--help) usage;;
    *) echo "Unknown option: $1"; usage;;
  esac
done

# -----------------------------------------------------
# Helper to run tests safely
# -----------------------------------------------------
run_test() {
  local name="$1"; local cmd="$2"; local id="$3"
  if [[ "$TEST" != "all" && "$TEST" != "$id" ]]; then return; fi
  echo -e "\n[TEST $id]: $name"
  echo "-----------------------------------------------------"
  echo "COMMAND: $cmd"
  local start_time=$(date +%s)
  set +e; eval $cmd >>"$OUTPUT_DIR/test_dryrun.log" 2>&1; local status=$?; set -e
  local end_time=$(date +%s); local duration=$((end_time - start_time))
  TOTAL=$((TOTAL + 1))
  if [[ $status -ne 0 ]] || grep -q "\[FAILURE\]" "$OUTPUT_DIR/debug.log" 2>/dev/null; then
    echo "[RESULT]: FAIL (${duration}s)"; FAIL=$((FAIL + 1))
  else
    echo "[RESULT]: SUCCESS (${duration}s)"; PASS=$((PASS + 1))
  fi
  echo "-----------------------------------------------------"; sleep 1
}

# -----------------------------------------------------
# Header
# -----------------------------------------------------
echo "====================================================="
echo " Akamai CPS Certificate Dry-Run Simulation Suite"
echo "====================================================="
echo " Section:       ${SECTION}"
echo " Access Group:  ${ACCESS_GROUP}"
echo " Selected Test: ${TEST}"
echo "-----------------------------------------------------"

# =====================================================
# 1. Basic Dry-Run Full Flow
# =====================================================
run_test "Basic Dry-Run" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn dryrun-basic.example.com --enrollment_id 10001 --action renew_and_deploy \
 --dry-run --json-only" "1"

# =====================================================
# 2. Get Enrollment (Discovery Simulation)
# =====================================================
run_test "Get Enrollment Only" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --action get_enrollment --dry-run --json-only" "2"

# =====================================================
# 3. Renew Only
# =====================================================
run_test "Renew Only" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn renewonly.example.com --enrollment_id 10002 --action renew_only \
 --dry-run --json-only" "3"

# =====================================================
# 4. Deploy Only
# =====================================================
run_test "Deploy Only" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn deployonly.example.com --enrollment_id 10003 --action deploy_only \
 --dry-run --json-only" "4"

# =====================================================
# 5. Scheduled Deployment
# =====================================================
SCHEDULE_TIME=$(date -u -d '+2 hours' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -v+2H -u '+%Y-%m-%dT%H:%M:%SZ')
run_test "Scheduled Deployment (Future Start)" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn schedule.example.com --enrollment_id 10004 --action renew_and_deploy \
 --schedule-time ${SCHEDULE_TIME} --dry-run --json-only" "5"

# =====================================================
# 6. Staging Network
# =====================================================
run_test "Staging Network Simulation" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn staging.example.com --enrollment_id 10005 --action renew_and_deploy \
 --deployment-network staging --dry-run --json-only" "6"

# =====================================================
# 7. Debug Logging Enabled
# =====================================================
run_test "Debug Logging Enabled" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn debug.example.com --enrollment_id 10006 --action renew_and_deploy \
 --dry-run --debug" "7"

# =====================================================
# 8. Expiry Template (7-Day Escalation)
# =====================================================
run_test "Expiry Template (7-Day)" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn seven.example.com --enrollment_id 10007 --action renew_and_deploy \
 --days-to-expiry 7 --dry-run --json-only" "8"

# =====================================================
# 9. Expiry Template (10-Day Escalation)
# =====================================================
run_test "Expiry Template (10-Day)" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn ten.example.com --enrollment_id 10008 --action renew_and_deploy \
 --days-to-expiry 10 --dry-run --json-only" "9"

# =====================================================
# 10. Expiry Template (14-Day Notification)
# =====================================================
run_test "Expiry Template (14-Day)" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn fourteen.example.com --enrollment_id 10009 --action renew_and_deploy \
 --days-to-expiry 14 --dry-run --json-only" "10"

# =====================================================
# 11. Full Integration (Poll Simulation)
# =====================================================
run_test "Full Integration (Poll Simulation)" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn poll.example.com --enrollment_id 10010 --action renew_and_deploy \
 --poll-interval 10 --poll-timeout 120 --dry-run --debug" "11"

# =====================================================
# 12. Default Template (certEmail.html Fallback)
# =====================================================
run_test "Default Template (Fallback)" \
"python akamai_cert_manager.py --section ${SECTION} --access_group ${ACCESS_GROUP} \
 --fqdn fallback.example.com --enrollment_id 10011 --action renew_and_deploy \
 --days-to-expiry 30 --dry-run --json-only" "12"

# =====================================================
# Summary
# =====================================================
echo "====================================================="
echo " Dry-Run Simulation Suite Summary"
echo "====================================================="
echo " Total Tests : $TOTAL"
echo " Passed      : $PASS"
echo " Failed      : $FAIL"
echo "-----------------------------------------------------"

if [[ $FAIL -eq 0 ]]; then
  PIPELINE_RESULT="SUCCESS"
else
  PIPELINE_RESULT="FAILURE"
fi

echo "PIPELINE_RESULT=$PIPELINE_RESULT"
echo "====================================================="
echo " Dry-Run Test Suite Completed ($PIPELINE_RESULT)"
echo "====================================================="
