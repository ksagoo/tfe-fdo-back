import json
import os
from urllib.parse import urljoin

def reverse_fqdn_lookup(session, base_url, fqdn, debug=False):
    """
    Perform a reverse lookup for a given FQDN using PAPI hostnames endpoint.
    Supports both array and object response schemas.
    """
    result = {
        "fqdn": fqdn,
        "groupId": None,
        "propertyName": None,
        "accessGroupName": None,
        "strippedPropertyName": None
    }

    try:
        url = urljoin(base_url, f"papi/v1/hostnames?search={fqdn}")
        if debug:
            print(f"[INFO] Performing PAPI reverse lookup: {url}")

        resp = session.get(url, timeout=30)
        if debug:
            print(f"[DEBUG] HTTP {resp.status_code} - {len(resp.text)} bytes")

        if resp.status_code != 200:
            print(f"[ERROR] PAPI reverse lookup failed with {resp.status_code}: {resp.text[:300]}")
            return result

        data = resp.json()

        #  Support both possible structures (list or dict with "hostnames" key)
        if isinstance(data, list):
            host_entries = data
        elif isinstance(data, dict):
            host_entries = data.get("hostnames", [])
        else:
            host_entries = []

        if debug:
            print(f"[DEBUG] Total host entries returned: {len(host_entries)}")

        for entry in host_entries:
            if not isinstance(entry, dict):
                continue

            cname_from = entry.get("cnameFrom", "").lower()
            if fqdn.lower() in cname_from:
                group_id = entry.get("groupId")
                property_name = entry.get("propertyName")

                # Derive access group via lookup function
                access_group_name = get_group_name_by_id(session, base_url, group_id)

                # Strip prefixes/suffixes
                stripped_name = property_name
                if stripped_name.startswith("SD-"):
                    stripped_name = stripped_name[3:]
                for suffix in ["-NonProd", "-Prod"]:
                    if stripped_name.endswith(suffix):
                        stripped_name = stripped_name[: -len(suffix)]

                # Populate result
                result.update({
                    "groupId": group_id,
                    "propertyName": property_name,
                    "accessGroupName": access_group_name,
                    "strippedPropertyName": stripped_name
                })

                # Always print summary
                print("\n=== Reverse FQDN Lookup Result ===")
                print(f"FQDN: {fqdn}")
                print(f"Group ID: {group_id}")
                print(f"Property Name: {property_name}")
                print(f"Access Group: {access_group_name}")
                print(f"Stripped Property Name: {stripped_name}")
                print("===================================\n")

                # Write debug file
                if debug:
                    os.makedirs("output", exist_ok=True)
                    out_file = os.path.join("output", f"reverse_lookup_{fqdn.replace('.', '_')}.json")
                    with open(out_file, "w") as f:
                        json.dump(result, f, indent=2)
                    print(f"[DEBUG] Reverse lookup JSON written to: {out_file}")

                return result  #  Stop after first valid match

        print(f"[WARN] No results found for {fqdn}")

    except Exception as e:
        print(f"[ERROR] reverse_fqdn_lookup() failed: {e}")

    return result
