#!/usr/bin/env python3
"""
Query Active Directory group members via HSBC LDAP API.
"""

import requests
import argparse
import urllib.parse
import json
from urllib.parse import urlparse, parse_qs, unquote

# ---------------------------------------------------------------------
# Constants (UNENCODED â€” requests handles escaping)
# ---------------------------------------------------------------------
DEFAULT_BASE_URL = "https://hsbc-ldap.prd.digital.gbm.cloud.hk.hsbc/hsbc-ldap"
DEFAULT_SERVER_URL = "ldaps://faa-lds-prod.uk.hsbc:3269"
DEFAULT_BASE_DN = "OU=HSBCPeople,OU=InfoDir,DC=Prod,DC=HSBC"
DEFAULT_MEMBER_PATH = (
    "OU=Cyber WASP Automation,OU=Applications,OU=Groups,"
    "OU=InfoDir,DC=Prod,DC=HSBC"
)

DEFAULT_EMAILS = [
    {"mail": "paul.dawson@hsbc.com"},
    {"mail": "paul.hiesley@hsbc.com"},
    {"mail": "pavan.prabhakar@hsbc.com"},
    {"mail": "kuldeep.sagoo@hsbc.com"},
    {"mail": "jijin.karumathilvellilapully@hsbc.com"},
]
FAILSAFE_EMAIL = "cyberwaspwafdevops@noexternalmail.hsbc.com"


# ---------------------------------------------------------------------
# Sanity Check
# ---------------------------------------------------------------------
def sanity_check_url(url):
    print("\n[DEBUG] Sanity check before live LDAP query:")
    parsed = urlparse(url)
    print(f"  Base URL: {parsed.scheme}://{parsed.netloc}{parsed.path}")
    query_params = parse_qs(parsed.query)
    for key, value in query_params.items():
        decoded_value = unquote(value[0])
        print(f"  {key} = {decoded_value}")
    if "member-of" in query_params:
        print("  Sanity check passed: 'member-of' present.\n")
    else:
        print("  Warning: missing 'member-of' parameter.\n")


# ---------------------------------------------------------------------
# Core Function
# ---------------------------------------------------------------------
def fetch_ad_user_details(group_name, dry_run=False, simulate_fail=False):
    if dry_run:
        if simulate_fail:
            print("[Dry Run: Simulated Failure] Returning fail-safe email alias.")
            return [{"mail": FAILSAFE_EMAIL}]
        print("[Dry Run] Returning static default email list.")
        return DEFAULT_EMAILS

    # Encode only the DN parts, not the protocol or port
    encoded_server_url = urllib.parse.quote(DEFAULT_SERVER_URL, safe=":/")
    encoded_base_dn = urllib.parse.quote(DEFAULT_BASE_DN, safe="=,")
    encoded_member_path = urllib.parse.quote(DEFAULT_MEMBER_PATH, safe="=,")
    encoded_group = urllib.parse.quote(group_name)

    url = (
        f"{DEFAULT_BASE_URL}?"
        f"serverUrl={encoded_server_url}"
        f"&baseDN={encoded_base_dn}"
        f"&attributes=mail"
        f"&member-of=CN%3DInfodir-{encoded_group}%2C{encoded_member_path}"
        f"&limit=100&ad=false&sentFrom=CyberWASP"
    )

    sanity_check_url(url)
    print(f"\n[INFO] Querying LDAP API:\n{url}\n")

    try:
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        data = response.json()
        if not data:
            print("[Warning] No AD members found. Using fail-safe email alias.")
            return [{"mail": FAILSAFE_EMAIL}]
        return data
    except Exception as e:
        print(f"[Error] Failed to fetch AD group details: {e}")
        print("[Fallback] Returning fail-safe email alias.")
        return [{"mail": FAILSAFE_EMAIL}]


# ---------------------------------------------------------------------
# CLI Entry Point
# ---------------------------------------------------------------------
if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--group_name", required=True)
    parser.add_argument("--dry_run", action="store_true")
    parser.add_argument("--simulate_fail", action="store_true")
    parser.add_argument("--flatten", action="store_true")
    parser.add_argument("--show_url", action="store_true")
    args = parser.parse_args()

    if args.show_url:
        encoded_server_url = urllib.parse.quote(DEFAULT_SERVER_URL, safe=":/")
        encoded_base_dn = urllib.parse.quote(DEFAULT_BASE_DN, safe="=,")
        encoded_member_path = urllib.parse.quote(DEFAULT_MEMBER_PATH, safe="=,")
        encoded_group = urllib.parse.quote(args.group_name)
        preview_url = (
            f"{DEFAULT_BASE_URL}?"
            f"serverUrl={encoded_server_url}"
            f"&baseDN={encoded_base_dn}"
            f"&attributes=mail"
            f"&member-of=CN%3DInfodir-{encoded_group}%2C{encoded_member_path}"
            f"&limit=100&ad=false&sentFrom=CyberWASP"
        )
        print(f"[SHOW_URL]\n{preview_url}\n")
        sanity_check_url(preview_url)
        exit(0)

    user_details = fetch_ad_user_details(
        args.group_name, dry_run=args.dry_run, simulate_fail=args.simulate_fail
    )

    if args.flatten:
        print(", ".join([u["mail"] for u in user_details]))
    else:
        print(json.dumps(user_details, indent=4))
