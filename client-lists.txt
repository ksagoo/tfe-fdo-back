flowchart TD
A[Start] --> B[Parse CLI arguments]
B --> C[Setup session & region metadata]
C --> D{isProd?}


%% --- Prod Branch: Left Side ---
D -- "True (Prod)" --> P1[Check if Security Config<br>and NonProd Policy exist]
P1 -->|Missing| PX[Abort:<br>prerequisites not met]
P1 -->|Exists| P2[Create Prod Policy<br>cloned from NonProd]
P2 --> P3[Copy match targets]
P3 --> P4[Consolidate hostnames<br>into Security Config]
P4 --> P5[Set version notes]
P5 --> Z[Print summary]


%% --- NonProd Branch: Right Side ---
D -- "False (NonProd)" --> N1[Check if Security Config exists]
N1 --> N2[If missing, clone from<br>Security Policy Template v1]
N2 --> N3[Create Security Config<br>and NonProd Policy]
N3 --> N4[Set version notes]
N4 --> N5[Assign hostnames]
N5 --> R


%% --- Reassignment Block (NonProd only) ---
subgraph R[Run all reassignments]
R1[Clone and rename client lists] -->
R2[Activate client lists in STAGING] -->
R3[Wait for Rate Control Bypass list<br>to become ACTIVE] -->
R4[Reassign match targets] -->
R5[Reassign custom rules] -->
R6[Reassign rate limits] -->
R7[Update rate policies] -->
R8[Reassign reputation profiles] -->
R9[Reassign DoS protection rate policies] -->
R10[Reassign slow POST protection] -->
R11[Reassign Akamai bot category actions] -->
R12[Reassign WAF rule exceptions] -->
R13[Reassign WAF group actions] -->
R14[Reassign WAF overrides] -->
R15[Reassign IP/Geo/ASN lists]
end


R15 --> N6[Delete temporary<br>template policy]
N6 --> Z[Print summary]
