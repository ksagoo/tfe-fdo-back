def reassign_waf_rule_exceptions(session, base_url, config_id, version, old_policy_id, new_policy_id):
    print("[INFO] RUNNING: reassign_waf_rule_exceptions")

    url = f"{base_url}/appsec/v1/configs/{config_id}/versions/{version}/waf/rules/exceptions"
    summary = {
        "processed": 0,
        "successful": 0,
        "failed": 0,
        "details": []
    }

    try:
        response = session.get(url)
        response.raise_for_status()
        exceptions = response.json().get("ruleExceptions", [])

        if not exceptions:
            print(f"[INFO] No WAF rule exceptions found for policy {old_policy_id}, skipping.")
            return summary

        reassigned = []
        for rule in exceptions:
            summary["processed"] += 1
            if rule.get("policyId") == old_policy_id:
                rule["policyId"] = new_policy_id
                reassigned.append(rule)

        if reassigned:
            put_resp = session.put(url, json={"ruleExceptions": reassigned})
            put_resp.raise_for_status()
            summary["successful"] = len(reassigned)
            summary["details"].append({
                "id": "waf_rule_exceptions",
                "status": "success",
                "count": len(reassigned)
            })

    except requests.exceptions.HTTPError as e:
        if e.response.status_code == 404:
            print(f"[INFO] No WAF rule exceptions found (404), skipping reassignment.")
        else:
            summary["failed"] += 1
            summary["details"].append({
                "id": "waf_rule_exceptions",
                "status": "failed",
                "error": str(e)
            })
    except Exception as ex:
        summary["failed"] += 1
        summary["details"].append({
            "id": "waf_rule_exceptions",
            "status": "failed",
            "error": str(ex)
        })

    return summary
