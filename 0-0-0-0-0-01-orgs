appsec/v1/configs

python export_appsec.py --config-name "My-Security-Config" --policy-prefix "NonP" 

import os
import sys
import yaml
import json
import argparse
import requests
from jinja2 import Environment, FileSystemLoader
from akamai.edgegrid import EdgeGridAuth, EdgeRc

# Setup API session
def setup_session(edgerc_path, section):
    from configparser import ConfigParser
    config = ConfigParser()
    config.read(edgerc_path)

    session = requests.Session()
    session.auth = EdgeGridAuth(
        client_token=config[section]["client_token"],
        client_secret=config[section]["client_secret"],
        access_token=config[section]["access_token"]
    )
    session.headers.update({'Content-Type': 'application/json'})
    base_url = f"https://{config[section]['host']}/"
    return session, base_url

# Get configuration ID from name
def get_config_id(session, base_url, config_name):
    url = urljoin(base_url, "/appsec/v1/configs")
    response = session.get(url)
    response.raise_for_status()
    configs = response.json().get("configurations", [])
    for config in configs:
        if config["name"] == config_name:
            return config["id"]
    raise Exception(f"Config '{config_name}' not found.")

# Get latest version
def get_latest_version(session, base_url, config_id):
    url = urljoin(base_url, f"/appsec/v1/configs/{config_id}/versions")
    response = session.get(url)
    response.raise_for_status()
    return response.json()["versions"][-1]["version"]

def get_policy_id_by_prefix(session, base_url, config_id, version, prefix):
    url = urljoin(base_url, f"/appsec/v1/configs/{config_id}/versions/{version}/security-policies")
    response = session.get(url)
    response.raise_for_status()
    policies = response.json()["securityPolicies"]
    for policy in policies:
        if policy["policyName"].startswith(prefix):
            return policy["policyId"]
    raise Exception(f"No policy found with prefix '{prefix}'.")

def export_module(session, base_url, url_path, filename):
    print(f"Fetching {filename}...")
    response = session.get(urljoin(base_url, url_path))
    response.raise_for_status()
    data = response.json()
    with open(os.path.join(OUTPUT_DIR, filename), "w") as f:
        json.dump(data, f, indent=2)
    print(f"Saved {filename}")

def export_all_modules(session, base_url, config_id, version, policy_id):
    export_module(session, base_url,
                  f"/appsec/v1/configs/{config_id}/versions/{version}/match-targets",
                  "match_targets.json")

    export_module(session, base_url,
                  f"/appsec/v1/configs/{config_id}/versions/{version}/security-policies/{policy_id}/client-list-overrides",
                  "client_list_overrides.json")

    export_module(session, base_url,
                  f"/appsec/v1/configs/{config_id}/versions/{version}/security-policies/{policy_id}/custom-rules",
                  "custom_rules.json")

    export_module(session, base_url,
                  f"/appsec/v1/configs/{config_id}/versions/{version}/security-policies/{policy_id}/reputation-profiles",
                  "reputation_profiles.json")

    export_module(session, base_url,
                  f"/appsec/v1/configs/{config_id}/versions/{version}/security-policies/{policy_id}/slow-post",
                  "slow_post_protection.json")

    export_module(session, base_url,
                  f"/appsec/v1/configs/{config_id}/versions/{version}/security-policies/{policy_id}/rate-policies",
                  "rate_limit_policies.json")

    export_module(session, base_url,
                  f"/appsec/v1/configs/{config_id}/versions/{version}/security-policies/{policy_id}/waf-rules",
                  "waf_rules.json")

    export_module(session, base_url,
                  f"/appsec/v1/configs/{config_id}/versions/{version}/security-policies/{policy_id}/advanced-settings/bot-manager",
                  "bot_manager.json")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Export Akamai AppSec configuration by config name and policy prefix.")
    parser.add_argument("--section", default='DEV', required=True, help="Section name from .edgerc")
    parser.add_argument("--config-name", required=True, help="Name of the security configuration to export")
    parser.add_argument("--prefix", default='TEMP', required=True, help="Policy name prefix to match (e.g., NonP or Prod)")
    parser.add_argument("--version", type=int, default=1, help="(Optional) Specific version number to export. Defaults to latest.")
    parser.add_argument("--output-dir", default="export", help="Directory to save exported JSON files")

    args = parser.parse_args()
    
    OUTPUT_DIR = args.output_dir
    os.makedirs(OUTPUT_DIR, exist_ok=True)

    session, base_url = setup_session(args.section)

    try:
        config_id = get_config_id(session, base_url, args.config_name)
        print(f"Found config ID: {config_id}")
    except Exception as e:
        print(f"Failed to get config ID: {e}")
        sys.exit(1)

    try:
        if args.version:
            version = args.version
            print(f"Using provided version: {version}")
        else:
            version = get_latest_version(session, base_url, config_id)
            print(f"Auto-detected latest version: {version}")
    except Exception as e:
        print(f"Failed to determine config version: {e}")
        sys.exit(1)

    try:
        policy_id = get_policy_id_by_prefix(session, base_url, config_id, version, args.prefix)
        print(f"Found policy ID: {policy_id}")
    except Exception as e:
        print(f"Failed to get policy ID: {e}")
        sys.exit(1)

    try:
        export_all_modules(session, base_url, config_id, version, policy_id)
        print("Export completed successfully.")
    except Exception as e:
        print(f"Export failed: {e}")
        sys.exit(1)
